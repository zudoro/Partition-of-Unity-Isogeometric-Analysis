MODULE LOADFUNCTION

	USE GEOMETRY

	IMPLICIT NONE

CONTAINS

TYPE(POINT2D) FUNCTION EX_DISP(PT2D, PATCH)

	INTEGER, INTENT(IN) :: PATCH
	TYPE(POINT2D), INTENT(IN) :: PT2D
	TYPE(POINT2D) :: PHY_PT
	REAL*8 :: R, THETA, X, Y
	INTEGER :: I

	PHY_PT = GET_PHY_PT(PT2D, PATCH)
	
	X = PHY_PT%X; Y = PHY_PT%Y
	
	CALL GET_RTHETA(R, THETA, PHY_PT)

	EX_DISP = POINT2D(0.D0, 0.D0)
	
	IF (PROBLEM.EQ.0) THEN
		EX_DISP%X = X
		EX_DISP%Y = Y
	ELSEIF (PROBLEM.EQ.1) THEN
		EX_DISP%X = X**2
		EX_DISP%Y = Y**2
	ELSEIF (PROBLEM.EQ.2) THEN
		EX_DISP%X = (X**2 + X)*(Y - 1.D0)
		EX_DISP%Y = X*Y**2
	ELSEIF (PROBLEM.EQ.3) THEN
		EX_DISP%X = R**(2.D0/3.D0)*DSIN((2.D0/3.D0)*THETA)
		EX_DISP%Y = R**(2.D0/3.D0)*DCOS((2.D0/3.D0)*THETA)
	ELSEIF (PROBLEM.EQ.4) THEN
		EX_DISP%X = (1.D0/(2.D0*MU))*R**LAMBDA*((KAPPA - Q*(LAMBDA + 1.D0))*DCOS(LAMBDA*THETA) - LAMBDA*DCOS((LAMBDA-2.D0)*THETA))
		EX_DISP%Y = (1.D0/(2.D0*MU))*R**LAMBDA*((KAPPA + Q*(LAMBDA + 1.D0))*DSIN(LAMBDA*THETA) + LAMBDA*DSIN((LAMBDA-2.D0)*THETA))
	ELSEIF (PROBLEM.EQ.5) THEN
		EX_DISP%X = R**(2.D0/3.D0)*DSIN((2.D0/3.D0)*THETA) + (1.D0/2.D0)*R**(4.D0/3.D0)*DSIN((4.D0/3.D0)*THETA) + & 
								(1.D0/3.D0)*R**(6.D0/3.D0)*DSIN((6.D0/3.D0)*THETA) + (1.D0/4.D0)*R**(8.D0/3.D0)*DSIN((8.D0/3.D0)*THETA) + &
								(1.D0/5.D0)*R**(10.D0/3.D0)*DSIN((10.D0/3.D0)*THETA)
		EX_DISP%Y = R**(2.D0/3.D0)*DCOS((2.D0/3.D0)*THETA) + (1.D0/2.D0)*R**(4.D0/3.D0)*DCOS((4.D0/3.D0)*THETA) + & 
								(1.D0/3.D0)*R**(6.D0/3.D0)*DCOS((6.D0/3.D0)*THETA) + (1.D0/4.D0)*R**(8.D0/3.D0)*DCOS((8.D0/3.D0)*THETA) + &
								(1.D0/5.D0)*R**(10.D0/3.D0)*DCOS((10.D0/3.D0)*THETA)
	ENDIF
	
END FUNCTION EX_DISP

TYPE(STRESS) FUNCTION EX_STRESS(PT2D, PATCH)
	
	TYPE(POINT2D), INTENT(IN) :: PT2D
	INTEGER, INTENT(IN) :: PATCH

	TYPE(POINT2D) :: PHY_PT
 	REAL*8 :: R, THETA, EX_STRAIN(3), STRESS_VEC(3), X, Y

	PHY_PT = GET_PHY_PT(PT2D, PATCH)
	X = PHY_PT%X; Y= PHY_PT%Y

	CALL GET_RTHETA(R, THETA, PHY_PT)
	EX_STRESS = STRESS(0.D0,0.D0,0.D0,0.D0,0.D0)

	IF (PROBLEM.EQ.0) THEN
		EX_STRAIN =  (/1.D0, 1.D0, 0.D0/)
	ELSEIF (PROBLEM.EQ.1) THEN
		EX_STRAIN(1) = 2.D0*X
		EX_STRAIN(2) = 2.D0*Y
		EX_STRAIN(3) = 0.D0
	ELSEIF (PROBLEM.EQ.2) THEN
		EX_STRAIN(1) = (2.D0*X + 1.D0)*(Y - 1.D0)
		EX_STRAIN(2) = 2.D0*X*Y
		EX_STRAIN(3) = X**2 + Y**2 + X
	ELSEIF (PROBLEM.EQ.3) THEN
		EX_STRAIN(1) = -2.D0*DSIN(THETA/3.D0)/(3.D0*R**(1.D0/3.D0))
		EX_STRAIN(2) = 2.D0*DSIN(THETA/3.D0)/(3.D0*R**(1.D0/3.D0))
		EX_STRAIN(3) = 4.D0*DCOS(THETA/3.D0)/(3.D0*R**(1.D0/3.D0))
	ELSEIF (PROBLEM.EQ.4) THEN
	!! Lambda = 2/3
! 		EX_STRAIN(1) = (13.D0*(-13.D0*DCOS(THETA/3.D0) + 5.D0*DCOS((7.D0*THETA)/3.D0)))/(225000.D0*R**(1.D0/3.D0))
! 		EX_STRAIN(2) = (13.D0*(37.D0*DCOS(THETA/3.D0) - 5.D0*DCOS((7.D0*THETA)/3.D0)))/(225000.D0*R**(1.D0/3.D0))
! 		EX_STRAIN(3) = (13.D0*(-5.D0*DSIN(THETA/3.D0) + DSIN((7.D0*THETA)/3.D0)))/(22500.D0*R**(1.D0/3.D0))
	!! Lambda = 0.544483737
		EX_STRESS%SXX = LAMBDA*R**(LAMBDA-1.D0)*((2.D0 - Q*(LAMBDA + 1.D0))*DCOS((LAMBDA - 1.D0)*THETA) - (LAMBDA - 1.D0)*DCOS((LAMBDA - 3.D0)*THETA))
		EX_STRESS%SYY = LAMBDA*R**(LAMBDA-1.D0)*((2.D0 + Q*(LAMBDA + 1.D0))*DCOS((LAMBDA - 1.D0)*THETA) + (LAMBDA - 1.D0)*DCOS((LAMBDA - 3.D0)*THETA))
		EX_STRESS%SXY = LAMBDA*R**(LAMBDA-1.D0)*((LAMBDA - 1.D0)*DSIN((LAMBDA - 3.D0)*THETA) + Q*(LAMBDA + 1.D0)*DSIN((LAMBDA - 1.D0)*THETA))
		GOTO 1
	ELSEIF (PROBLEM==5) THEN
		EX_STRAIN(1) = (2.D0*(-1 + R**(2.D0/3.D0) + R**(4.D0/3.D0) + R**2 + R**(8.D0/3.D0) + 2.D0*(R**(4.D0/3.D0) + R**2 + R**(8.D0/3.D0))*DCOS((2.D0*THETA)/3.D0) + 2.D0*(R**2 + R**(8.D0/3.D0))*DCOS((4*THETA)/3.D0) + 2.D0*R**(8.D0/3.D0)*DCOS(2.D0*THETA))*DSIN(THETA/3.D0))/(3.D0*R**(1.D0/3.D0))
		EX_STRAIN(2) = (-2.D0*(-1 + R**(2.D0/3.D0) + R**(4.D0/3.D0) + R**2 + R**(8.D0/3.D0) + 2.D0*(R**(4.D0/3.D0) + R**2 + R**(8.D0/3.D0))*DCOS((2.D0*THETA)/3.D0) + 2.D0*(R**2 + R**(8.D0/3.D0))*DCOS((4*THETA)/3.D0) + 2.D0*R**(8.D0/3.D0)*DCOS(2.D0*THETA))*DSIN(THETA/3.D0))/(3.D0*R**(1.D0/3.D0))
		EX_STRAIN(3) = (4.D0*DCOS(THETA/3.D0)*(1 + R**(2.D0/3.D0) - R**(4.D0/3.D0) + R**2 - R**(8.D0/3.D0) + 2.D0*(R**(4.D0/3.D0) - R**2 + R**(8.D0/3.D0))*DCOS((2.D0*THETA)/3.D0) - 2.D0*(-1 + R**(2.D0/3.D0))*R**2.D0*DCOS((4*THETA)/3.D0) + 2.D0*R**(8.D0/3.D0)*DCOS(2.D0*THETA)))/(3.D0*R**(1.D0/3.D0))
	ENDIF
	STRESS_VEC = MATMUL(STRESS_E, EX_STRAIN)
	EX_STRESS = STRESS(STRESS_VEC(1), STRESS_VEC(2), STRESS_VEC(3), 0.D0, 0.D0)
	1 CONTINUE
END FUNCTION EX_STRESS

SUBROUTINE TRACTION(TRC, PTS, PATCH, GAMMA_INDX)
	INTEGER, INTENT(IN) :: GAMMA_INDX, PATCH
	TYPE(POINT2D), INTENT(IN) :: PTS(:)
	TYPE(POINT2D), INTENT(OUT) :: TRC(UBOUND(PTS,1))
	
	TYPE(POINT2D) :: NORMAL
	TYPE(STRESS) :: SIGMA
	INTEGER :: I, N

	N = UBOUND(PTS,1)

	TRC(:) = POINT2D(0.D0, 0.D0)

	IF (GAMMA_INDX.EQ.1) THEN
		NORMAL = POINT2D(0.D0, -1.D0)
	ELSEIF (GAMMA_INDX.EQ.2) THEN
		NORMAL = POINT2D(1.D0, 0.D0)
	ELSEIF (GAMMA_INDX.EQ.3) THEN
		NORMAL = POINT2D(0.D0, 1.D0)
	ELSEIF (GAMMA_INDX.EQ.4) THEN
		NORMAL = POINT2D(-1.D0, 0.D0)
	ELSEIF (GAMMA_INDX.EQ.5) THEN
		NORMAL = POINT2D(0.D0, -1.D0)
	ELSEIF (GAMMA_INDX.EQ.6) THEN
		NORMAL = POINT2D(1.D0, 0.D0)
	ENDIF

! 	NORMAL = ROTATION(NORMAL, -135.D0*DEGREE)
	
	DO I=1, N
		SIGMA = EX_STRESS(PTS(I), PATCH)
		TRC(I)%X = NORMAL%X*SIGMA%SXX + NORMAL%Y*SIGMA%SXY
		TRC(I)%Y = NORMAL%Y*SIGMA%SYY + NORMAL%X*SIGMA%SXY
	ENDDO
	
END SUBROUTINE TRACTION

TYPE(POINT2D) FUNCTION LDFT2D(PT2D, PATCH)

	TYPE(POINT2D), INTENT(IN) :: PT2D
	INTEGER, INTENT(IN) :: PATCH

	TYPE(POINT2D) :: PHY_PT
	REAL*8 :: X, Y, R, THETA

	PHY_PT = GET_PHY_PT(PT2D, PATCH)
	X = PHY_PT%X; Y= PHY_PT%Y

	CALL GET_RTHETA(R, THETA, PHY_PT)

	IF (PROBLEM.EQ.0) THEN
			LDFT2D = POINT2D(0.D0,0.D0)
	ELSEIF (PROBLEM.EQ.1) THEN
		LDFT2D%X = -2.D0*STRESS_E11
		LDFT2D%Y = -2.D0*STRESS_E22
	ELSEIF (PROBLEM.EQ.2) THEN
		LDFT2D%X = -(10000.D0/91)*(33.D0*Y - 20.D0)
		LDFT2D%Y = -(5000.D0/91)*(66*X + 13.D0)
	ELSEIF (PROBLEM.EQ.3) THEN
		LDFT2D%X = 5000.D0*DSIN(4.D0*THETA/3.D0)/(39.D0*R**(4.D0/3.D0))
		LDFT2D%Y = 5000.D0*DCOS(4.D0*THETA/3.D0)/(39.D0*R**(4.D0/3.D0))
	ELSEIF (PROBLEM.EQ.4) THEN
		LDFT2D%X = 0.D0
		LDFT2D%Y = 0.D0
	ELSEIF (PROBLEM.EQ.5) THEN
		LDFT2D%X = 0.D0
		LDFT2D%Y = 0.D0
	ENDIF

END FUNCTION LDFT2D

END MODULE LOADFUNCTION
